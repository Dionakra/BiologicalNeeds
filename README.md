[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

<h1 align="center">Cell Tracking according to Biological Needs</h1>
<h2 align="center">Strong Mitosis-aware Random-finite Sets Tracker with Aleatoric Uncertainty</h2>

<p align="center">
  <img alt="Fluo-N2DH-SIM+" src="./assets/teaser.png">
  <br>
    <em>The output distribution of EmbedTrack using different input transformations on BF-C2DL-HSC.</em>
</p>


**Note:** This repository is under construction. Names, links and other information will be updated soon.


### Introduction
This repository provides a modified version used in the 
**[7th ISBI challenge](https://celltrackingchallenge.net/ctc-vii/)** of 
the method described in the
**[Paper](https://arxiv.org/abs/2403.15011)**
**Cell Tracking according to Biological Needs - 
Strong Mitosis-aware Random-finite Sets Tracker with Aleatoric Uncertainty**. 
The modifications are described [here](AFTER_ISBI_SUBMISSION).

The framework is partially built on top of the **[EmbedTrack](https://git.scc.kit.edu/kit-loe-ge/embedtrack)** 
repository of **Loeffler et al.**. We removed the training scripts and unrelated code that is not needed 
for the inference. The method *EmbedTrack* is extended with test time augmentation 
to generate association distributions.
We refer to the original repository for training scripts and
more detailed information about the method.
The association distributions are stored 
during inference alongside the tracking masks and are used to generate the final 
tracking results explained in the next paragraph.

The multi hypothesis tracking framework is located in the 'mht' folder. The global
association framework is applied to the association distributions generated by EmbedTrack
and creates a final tracking result. The tracking result is saved in the CTC format
and can be evaluated by the CTC.

To make our code more accessible, we added a **[Google Colab Notebook](ynb)** 
for simple inference on data sets from the Cell Tracking Challenge. 
The Colab notebook includes all steps: setting up the environment, 
retrieving the CTC data sets and inference.


### Dependencies 
We have tested this implementation using `pytorch` version 1.13 and `cudatoolkit` version 11.7 on a `linux` OS machine. 

To create the environment `venv_embedtrack` please run
```
conda env create -f path/to/environment.yml
```


### Datasets
We evaluated our approach on 2D data sets from the **[Cell Tracking Challenge (CTC)](http://celltrackingchallenge.net)**:
"Fluo-N2DH-SIM+",
"Fluo-C2DL-MSC",
"Fluo-N2DH-GOWT1",
"PhC-C2DL-PSC",
"BF-C2DL-HSC",
"Fluo-N2DL-HeLa",
"BF-C2DL-MuSC",
"DIC-C2DH-HeLa", and
"PhC-C2DH-U373"-- all can be retrieved from [here](http://celltrackingchallenge.net/2d-datasets/).

### Pretrained Models
We use the pretrained models from **[Loeffler et al.](https://git.scc.kit.edu/kit-loe-ge/embedtrack)**.
The pretrained models are located in the `models` folder, such that the structure is as follows:
```
models
└───BF-C2DL-HSC
    └───best_iou_model.pth
    └───config.json
└───BF-C2DL-MuSC
    └───best_iou_model.pth
    └───config.json
....
```

You can download the models by typing 
```bash
tbd
```


### Inference on CTC Datasets
To train on the CTC datasets please download and unzip the aforementioned datasets from the CTC from [here](http://celltrackingchallenge.net/2d-datasets/). Save the training data (without any renaming) of each cell type, called **Training Dataset** on the CTC website, to the folder: 
```
...\Data\train
```
and save the challenge datasets of each cell type, called **Challenge Dataset** on the CTC website, to the folder:
```
...\Data\challenge
```
After that you should have a structure in the `Data` folder as follows:

```
Data
└───train
    |───BF-C2DL-HSC
        └───01
            └───0000.tif
            ....
        └───01_GT
        └───01_ST
        └───01_ERR_SEG
            ....
        ───02
            └───0000.tif
            ....
        └───02_GT
        └───02_ST
        └───02_ERR_SEG
            ....
    └───BF-C2DL-MuSC
    ......
    
└───challenge
    |───BF-C2DL-HSC
        └───01
            └───0000.tif
            ....
        ───02
            └───0000.tif
            ....
            
    └───BF-C2DL-MuSC
    ......
    
```

First, run the extended EmbedTrack framework to generate the association 
distributions and cell masks by typing (change hyperparameter according to your needs):

```bash
OUTPUT=results/embedtrack
DATA=DIC-C2DH-HeLa

python ./embedtrack/scripts/infer_single_dataset.py \
  --train \
  --dataset=$DATA \
  --res-path=$OUTPUT \
  --shifts=50 \
  --multiscale \
  --multisegmentation
```

The EmbedTrack predictions with distribution information are saved to the 
`results_embedtrack`folder. 

The next step is to apply our multi hypothesis tracking framework to the association distributions.
This can be done by running the following command:
```bash
INPUT=results/embedtrack
OUTPUT=results/mht
DATA=DIC-C2DH-HeLa
SUBSET=train

python /home/kaiser/code_dev/EmbedTrack/mht/inference.py \
    --challenge ${VARIABLE} \
    --data-root ${INPUT} \
    --destination-root ${OUTPUT} \
    --subset ${SUBSET}
```

If you want to interpolate missing masks tracking results, you can run the following command:
```bash
INPUT=results/mht
OUTPUT=results/interpolated
DATA=DIC-C2DH-HeLa
SUBSET=train

python /home/kaiser/code_dev/EmbedTrack/mht/interpolate.py \
    --challenge ${VARIABLE} \
    --data-root ${INPUT} \
    --destination-root ${OUTPUT} \
    --subset ${SUBSET}
```


### CTC Trained Models and Executables
We participated as team ctc741 on the ISBI 24 Cell Tracking Challenge 
(Linking Only). The pretrained models from 
**[Loeffler et al.](https://git.scc.kit.edu/kit-loe-ge/embedtrack)**
and precompiled executables of our submission can be found 
[here](http://celltrackingchallenge.net/participants/KIT-Loe-GE/).

If you want to create the executables yourself, please read the instructions in 
the [instruction file](CTC submission\README.txt).


### Citation
If you use our work in your research, please cite:

```bibtex
@article{kaiser2024cell,
  title={Cell Tracking according to Biological Needs--Strong Mitosis-aware Random-finite Sets Tracker with Aleatoric Uncertainty},
  author={Kaiser, Timo and Schier, Maximilian and Rosenhahn, Bodo},
  journal={arXiv preprint arXiv:2403.15011},
  year={2024}
}
```

### Acknowledments
Our code as well as this ReadMe is based on the repository of **[Loeffler et al.](https://git.scc.kit.edu/kit-loe-ge/embedtrack)** which we would like to thank for making their code publicly available.
